exports.id=122,exports.ids=[122],exports.modules={2199:(e,t,s)=>{Promise.resolve().then(s.bind(s,41660))},30223:(e,t,s)=>{Promise.resolve().then(s.bind(s,90426))},39727:()=>{},41660:(e,t,s)=>{"use strict";s.d(t,{Providers:()=>r});let r=(0,s(12907).registerClientReference)(function(){throw Error("Attempted to call Providers() from the server but Providers is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"C:\\Users\\EQUIPO 2\\whatsapp-clean\\src\\app\\providers\\Providers.tsx","Providers")},47990:()=>{},61135:()=>{},80785:(e,t,s)=>{Promise.resolve().then(s.t.bind(s,86346,23)),Promise.resolve().then(s.t.bind(s,27924,23)),Promise.resolve().then(s.t.bind(s,35656,23)),Promise.resolve().then(s.t.bind(s,40099,23)),Promise.resolve().then(s.t.bind(s,38243,23)),Promise.resolve().then(s.t.bind(s,28827,23)),Promise.resolve().then(s.t.bind(s,62763,23)),Promise.resolve().then(s.t.bind(s,97173,23))},90426:(e,t,s)=>{"use strict";s.d(t,{Providers:()=>a});var r=s(60687),o=s(94441);function a({children:e}){return(0,r.jsx)(o.q,{children:e})}},90513:(e,t,s)=>{Promise.resolve().then(s.t.bind(s,16444,23)),Promise.resolve().then(s.t.bind(s,16042,23)),Promise.resolve().then(s.t.bind(s,88170,23)),Promise.resolve().then(s.t.bind(s,49477,23)),Promise.resolve().then(s.t.bind(s,29345,23)),Promise.resolve().then(s.t.bind(s,12089,23)),Promise.resolve().then(s.t.bind(s,46577,23)),Promise.resolve().then(s.t.bind(s,31307,23))},94431:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>d,metadata:()=>l});var r=s(37413),o=s(35759),a=s.n(o),n=s(87305),i=s.n(n);s(61135);var c=s(41660);let l={title:"Create Next App",description:"Generated by create next app"};function d({children:e}){return(0,r.jsx)("html",{lang:"es",children:(0,r.jsx)("body",{className:`${a().variable} ${i().variable}`,children:(0,r.jsx)(c.Providers,{children:e})})})}},94441:(e,t,s)=>{"use strict";let r,o;s.d(t,{q:()=>u,M:()=>h});var a=s(60687),n=s(43210);class i{constructor(){if(!process.env.WHATSAPP_PHONE_NUMBER_ID)throw Error("Missing WHATSAPP_PHONE_NUMBER_ID in environment");this.baseUrl=`https://graph.facebook.com/v19.0/${process.env.WHATSAPP_PHONE_NUMBER_ID}`}async getContacts(){try{return[{id:"521234567890",name:"Cliente Ejemplo",lastMessage:"Hola, \xbfc\xf3mo est\xe1s?",unread:2,lastMessageTime:new Date}]}catch(e){throw console.error("Error fetching contacts:",e),e}}async sendText(e,t){let s=await fetch(`${this.baseUrl}/messages`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({messaging_product:"whatsapp",recipient_type:"individual",to:e,text:{body:t}})});return this.handleResponse(s)}getHeaders(){if(!process.env.WHATSAPP_ACCESS_TOKEN)throw Error("Missing WHATSAPP_ACCESS_TOKEN in environment");return{Authorization:`Bearer ${process.env.WHATSAPP_ACCESS_TOKEN}`,"Content-Type":"application/json"}}async handleResponse(e){if(!e.ok){let t=await e.json();throw console.error("WhatsApp API Error:",t),Error(t.error?.message||"WhatsApp API error")}return e.json()}}var c=s(12518);async function l(){if(!r){if(!process.env.MONGODB_URI)throw Error("MONGODB_URI no est\xe1 definido en las variables de entorno");r=new c.MongoClient(process.env.MONGODB_URI),await r.connect(),o=r.db(process.env.MONGODB_DB||"whatsapp-business")}return o}async function d(e,t=50,s){try{let r=await l(),o={$or:[{from:e},{to:e}]};return s&&(o.timestamp={$lt:s}),(await r.collection("messages").find(o).sort({timestamp:-1}).limit(t).toArray()).map(e=>({id:e.id,text:e.text||"",direction:e.direction||"inbound",timestamp:e.timestamp instanceof Date?e.timestamp.toISOString():e.timestamp||new Date().toISOString(),...e.status&&{status:e.status},...e.type&&{type:e.type},...e.media&&{media:e.media}}))}catch(e){throw console.error("[DB] Error al obtener mensajes:",e),e}}async function m(){try{let e=await l(),t=[{$sort:{timestamp:-1}},{$group:{_id:{$cond:[{$eq:["$direction","outbound"]},"$to","$from"]},lastMessage:{$first:"$$ROOT"}}},{$replaceRoot:{newRoot:"$lastMessage"}}];return(await e.collection("messages").aggregate(t).toArray()).map(e=>({id:e.id,text:e.text||"",direction:e.direction||"inbound",timestamp:e.timestamp instanceof Date?e.timestamp.toISOString():e.timestamp||new Date().toISOString(),...e.status&&{status:e.status},...e.type&&{type:e.type},...e.media&&{media:e.media}}))}catch(e){throw console.error("[DB] Error al obtener \xfaltimos mensajes:",e),e}}(async function e(){try{let e=await l();await e.collection("messages").createIndex({from:1}),await e.collection("messages").createIndex({to:1}),await e.collection("messages").createIndex({timestamp:-1}),await e.collection("messages").createIndex({from:1,to:1,timestamp:-1}),console.log("[DB] \xcdndices creados correctamente")}catch(e){console.error("[DB] Error al crear \xedndices:",e)}})().catch(console.error);let g=s(94839).io,p=(0,n.createContext)(void 0),u=({children:e})=>{let[t,s]=(0,n.useState)({contacts:[],messages:[],selectedContact:null,loading:!1,error:null,unreadCounts:{}}),[r,o]=(0,n.useState)(null),c=new i;(0,n.useEffect)(()=>{let e=g(process.env.NEXT_PUBLIC_SOCKET_URL||"http://localhost:3001",{transports:["websocket"],reconnectionAttempts:5,reconnectionDelay:1e3});return e.on("connect",()=>{console.log("Conectado al servidor Socket.io")}),e.on("disconnect",()=>{console.log("Desconectado del servidor Socket.io")}),e.on("newMessage",e=>{s(t=>{let s=t.contacts.map(t=>t.id===e.from||t.id===e.to?{...t,lastMessage:e.text,lastMessageTime:e.timestamp}:t),r={...t.unreadCounts};t.selectedContact!==e.from&&"inbound"===e.direction&&(r[e.from]=(r[e.from]||0)+1);let o=t.messages.findIndex(t=>t.id===e.id);if(-1!==o){let a=[...t.messages];return a[o]=e,{...t,contacts:s,messages:a,unreadCounts:r}}return{...t,contacts:s,messages:[e,...t.messages],unreadCounts:r}})}),o(e),()=>{e.disconnect()}},[]);let l=(0,n.useCallback)(async()=>{s(e=>({...e,loading:!0,error:null}));try{let e=await fetch("/api/whatsapp/contacts");if(!e.ok)throw Error("Error al cargar contactos");let t=await e.json(),r=[];if(t.length>0)try{r=await m()}catch(e){console.error("Error al obtener \xfaltimos mensajes:",e)}let o=t.map(e=>{let t=r.find(t=>t.from===e.id||t.to===e.id);return{...e,lastMessage:t?.text||"",lastMessageTime:t?.timestamp||new Date().toISOString(),isOnline:Math.random()>.5}});s(e=>({...e,contacts:o,loading:!1}))}catch(e){console.error("Error loading contacts:",e),s(e=>({...e,error:"Error al cargar contactos",loading:!1}))}},[]),u=(0,n.useCallback)(async e=>{if(t.selectedContact&&e.trim()){s(e=>({...e,loading:!0,error:null}));try{let o=`temp-${Date.now()}`,a={id:o,from:t.selectedContact,text:e,timestamp:new Date().toISOString(),direction:"outbound",status:"sending"};s(e=>({...e,messages:[...e.messages,a]}));let n=await c.sendText(t.selectedContact,e);s(e=>({...e,messages:e.messages.map(e=>e.id===o?{...e,id:n.id,status:"sent"}:e),loading:!1})),s(s=>({...s,contacts:s.contacts.map(s=>s.id===t.selectedContact?{...s,lastMessage:e,lastMessageTime:new Date().toISOString()}:s)})),r&&r.emit("newMessage",{...a,id:n.id,status:"sent"})}catch(e){console.error("Error sending message:",e),s(e=>({...e,messages:e.messages.filter(e=>!e.id.startsWith("temp-")),error:"Error al enviar mensaje",loading:!1}))}}},[t.selectedContact,r]),h=(0,n.useCallback)(async e=>{s(t=>({...t,selectedContact:e,loading:!0,error:null,unreadCounts:{...t.unreadCounts,[e]:0}}));try{let t=await d(e);s(e=>({...e,messages:t,loading:!1}))}catch(e){console.error("Error loading messages:",e),s(e=>({...e,error:"Error al cargar mensajes",loading:!1}))}},[]),v=(0,n.useCallback)(async()=>{if(t.selectedContact&&0!==t.messages.length&&!t.loading){s(e=>({...e,loading:!0,error:null}));try{let e=t.messages[t.messages.length-1];if(!e?.timestamp)return console.warn("No se encontr\xf3 timestamp en el mensaje m\xe1s antiguo"),s(e=>({...e,loading:!1}));let r="string"==typeof e.timestamp?e.timestamp:e.timestamp instanceof Date?e.timestamp.toISOString():new Date().toISOString(),o=await d(t.selectedContact,20,r);s(e=>({...e,messages:o.length>0?[...e.messages,...o]:e.messages,loading:!1}))}catch(e){console.error("Error al cargar m\xe1s mensajes:",e),s(e=>({...e,error:"Error al cargar m\xe1s mensajes",loading:!1}))}}},[t.selectedContact,t.messages,t.loading]),f=(0,n.useCallback)(e=>{s(t=>({...t,messages:t.messages.map(t=>t.id===e?{...t,status:"read"}:t)}))},[]);return(0,n.useEffect)(()=>{l();let e=setInterval(l,3e4);return()=>clearInterval(e)},[l]),(0,a.jsx)(p.Provider,{value:{...t,selectContact:h,sendMessage:u,refreshContacts:l,loadMoreMessages:v,markAsRead:f},children:e})},h=()=>{let e=(0,n.useContext)(p);if(!e)throw Error("useWhatsApp debe usarse dentro de WhatsAppProvider");return e}}};