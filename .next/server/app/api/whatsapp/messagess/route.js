(()=>{var e={};e.id=414,e.ids=[414],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12518:e=>{"use strict";e.exports=require("mongodb")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},46434:(e,t,r)=>{"use strict";let s,a;r.r(t),r.d(t,{patchFetch:()=>v,routeModule:()=>f,serverHooks:()=>j,workAsyncStorage:()=>h,workUnitAsyncStorage:()=>y});var o={};r.r(o),r.d(o,{GET:()=>w,POST:()=>g,dynamic:()=>x});var n=r(96559),i=r(48088),c=r(37719),p=r(32190),u=r(12518);async function d(){if(!s){if(!process.env.MONGODB_URI)throw Error("MONGODB_URI no est\xe1 definido en las variables de entorno");s=new u.MongoClient(process.env.MONGODB_URI),await s.connect(),a=s.db(process.env.MONGODB_DB||"whatsapp-business")}return a}async function l(e){try{let t=(await d()).collection("messages"),r={...e,createdAt:new Date,updatedAt:new Date},s=await t.insertOne(r);return console.log(`[DB] Mensaje guardado con ID: ${s.insertedId}`),{...r,_id:s.insertedId}}catch(e){throw console.error("[DB] Error al guardar mensaje:",e),e}}async function m(e,t=50,r){try{let s=await d(),a={$or:[{from:e},{to:e}]};return r&&(a.timestamp={$lt:r}),(await s.collection("messages").find(a).sort({timestamp:-1}).limit(t).toArray()).map(e=>({id:e.id,text:e.text||"",direction:e.direction||"inbound",timestamp:e.timestamp instanceof Date?e.timestamp.toISOString():e.timestamp||new Date().toISOString(),...e.status&&{status:e.status},...e.type&&{type:e.type},...e.media&&{media:e.media}}))}catch(e){throw console.error("[DB] Error al obtener mensajes:",e),e}}async function w(e){let{searchParams:t}=new URL(e.url),r=t.get("contact"),s=t.get("before");if(!r)return p.NextResponse.json({error:"Se requiere el par\xe1metro contact"},{status:400});try{let e=await m(r,50,s||void 0);return p.NextResponse.json(e)}catch(e){return console.error("Error en GET /api/whatsapp/messages:",e),p.NextResponse.json({error:"Error al obtener mensajes"},{status:500})}}async function g(e){try{let t=await e.json();if(!t.from||!t.timestamp)return p.NextResponse.json({error:"Datos del mensaje incompletos"},{status:400});let r=await l(t);return p.NextResponse.json(r)}catch(e){return console.error("Error en POST /api/whatsapp/messages:",e),p.NextResponse.json({error:"Error al guardar mensaje"},{status:500})}}(async function e(){try{let e=await d();await e.collection("messages").createIndex({from:1}),await e.collection("messages").createIndex({to:1}),await e.collection("messages").createIndex({timestamp:-1}),await e.collection("messages").createIndex({from:1,to:1,timestamp:-1}),console.log("[DB] \xcdndices creados correctamente")}catch(e){console.error("[DB] Error al crear \xedndices:",e)}})().catch(console.error);let x="force-dynamic",f=new n.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/whatsapp/messagess/route",pathname:"/api/whatsapp/messagess",filename:"route",bundlePath:"app/api/whatsapp/messagess/route"},resolvedPagePath:"C:\\Users\\EQUIPO 2\\whatsapp-clean\\src\\app\\api\\whatsapp\\messagess\\route.ts",nextConfigOutput:"",userland:o}),{workAsyncStorage:h,workUnitAsyncStorage:y,serverHooks:j}=f;function v(){return(0,c.patchFetch)({workAsyncStorage:h,workUnitAsyncStorage:y})}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[719,580],()=>r(46434));module.exports=s})();