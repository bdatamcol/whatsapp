(()=>{var e={};e.id=274,e.ids=[274],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},6272:(e,t,r)=>{"use strict";let s;r.r(t),r.d(t,{patchFetch:()=>E,routeModule:()=>O,serverHooks:()=>j,workAsyncStorage:()=>v,workUnitAsyncStorage:()=>b});var o={};r.r(o),r.d(o,{GET:()=>y,POST:()=>x});var n=r(96559),a=r(48088),i=r(37719),c=r(32190),p=r(73825);r(12518);let u=process.env.MONGODB_URI||"mongodb://localhost:27017",l=process.env.MONGODB_DB||"whatsapp-business",d=!1;async function h(e){return console.log("[DB] Guardando mensaje:",e.id),{success:!0}}class g{async processMessage(e){try{console.log("[WEBHOOK] Procesando mensaje:",e?.id);let t={id:e.id,from:e.from,text:e.text?.body||"",timestamp:new Date(1e3*parseInt(e.timestamp)).toISOString(),direction:"inbound",type:e.type,media:"text"!==e.type?{url:e[e.type]?.url,caption:e[e.type]?.caption}:void 0};if(!t.from||!t.text)return void console.error("Mensaje inv\xe1lido:",e);await h(t);let r=this.generateResponse(t.text);return await this.client.sendText(t.from,r),{success:!0}}catch(e){throw console.error("Error en processMessage:",e),e}}generateResponse(e){let t=e.toLowerCase();return t.includes("hola")?"\xa1Hola! \xbfEn qu\xe9 puedo ayudarte?":t.includes("gracias")?"\xa1Es un placer ayudarte! \uD83D\uDE0A":"Hemos recibido tu mensaje. Te responderemos pronto."}constructor(){this.client=new p.A}}async function m(e){if(new g,console.log("[WEBHOOK] Iniciando procesamiento"),!e||"whatsapp_business_account"!==e.object)return void console.error("[WEBHOOK] Payload inv\xe1lido");try{let t=new g,r=e.entry?.[0],s=r?.changes?.[0],o=s?.value?.messages?.[0];o?(console.log("[WEBHOOK] Mensaje detectado:",o.type),await t.processMessage(o)):console.log("[WEBHOOK] Evento sin mensaje:",s?.value)}catch(e){throw console.error("[WEBHOOK] Error procesando mensaje:",e),e}}let w=process.env.WHATSAPP_WEBHOOK_TOKEN||"MTT0K3N123";async function y(e){let t=new URL(e.url),r=t.searchParams.get("hub.verify_token"),s=t.searchParams.get("hub.challenge");return(console.log("Token recibido:",r),r===w&&s)?new Response(s,{status:200,headers:{"Content-Type":"text/plain"}}):new Response("Token inv\xe1lido",{status:403})}async function x(e){try{let t=await e.json();return console.log("Mensaje recibido:",JSON.stringify(t,null,2)),await m(t),c.NextResponse.json({success:!0})}catch(e){return console.error("Error en POST:",e),c.NextResponse.json({error:"Error interno"},{status:500})}}let O=new n.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/whatsapp/webhook/route",pathname:"/api/whatsapp/webhook",filename:"route",bundlePath:"app/api/whatsapp/webhook/route"},resolvedPagePath:"C:\\Users\\EQUIPO 2\\whatsapp-clean\\src\\app\\api\\whatsapp\\webhook\\route.ts",nextConfigOutput:"",userland:o}),{workAsyncStorage:v,workUnitAsyncStorage:b,serverHooks:j}=O;function E(){return(0,i.patchFetch)({workAsyncStorage:v,workUnitAsyncStorage:b})}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12518:e=>{"use strict";e.exports=require("mongodb")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73825:(e,t,r)=>{"use strict";r.d(t,{A:()=>s});class s{constructor(){this.baseUrl="https://graph.facebook.com/v19.0/573143728457"}async getContacts(){try{return[{id:"521234567890",name:"Cliente Ejemplo",lastMessage:"Hola, \xbfc\xf3mo est\xe1s?",unread:2,lastMessageTime:new Date}]}catch(e){throw console.error("Error fetching contacts:",e),e}}async sendText(e,t){let r=await fetch(`${this.baseUrl}/messages`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({messaging_product:"whatsapp",recipient_type:"individual",to:e,text:{body:t}})});return this.handleResponse(r)}getHeaders(){return{Authorization:"Bearer EAAdmskc6SHwBOxuBjULMfPWk2V6AmDlfeZCTUDUtgj4UmAXAICaI7QEO5H5vH5gZCPOsEC555PIFBv3ob13L1kl0f7Jlt79b99R1IEWEkCZAZBbiNZCFNZCbHjH3k6WxKTD5j5hvC3Y5awZBwDjk3JnYG5BIzr9Hr0p1PpzO0YUqSwiu5rU2fRUdZBg1Px7thVXNZCuJLaYLpVLdzVCPshkPD2iFvpxoZD","Content-Type":"application/json"}}async handleResponse(e){if(!e.ok){let t=await e.json();throw console.error("WhatsApp API Error:",t),Error(t.error?.message||"WhatsApp API error")}return e.json()}}},78335:()=>{},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[719,580],()=>r(6272));module.exports=s})();