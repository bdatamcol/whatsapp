(()=>{var e={};e.id=274,e.ids=[274],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},18014:()=>{},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55009:(e,r,s)=>{"use strict";s.r(r),s.d(r,{patchFetch:()=>E,routeModule:()=>m,serverHooks:()=>y,workAsyncStorage:()=>v,workUnitAsyncStorage:()=>x});var t={};s.r(t),s.d(t,{GET:()=>g,POST:()=>w});var o=s(96559),a=s(48088),n=s(37719),i=s(32190),c=s(73825),p=s(18014),u=s(68311);class l{async processMessage(e){try{console.log("[WEBHOOK] Procesando mensaje:",e?.id);let r=(0,p.parseIncomingMessage)(e);if(!r.from||!r.text)return void console.error("Mensaje inv\xe1lido:",e);await (0,u.saveMessageToDatabase)(r);let s=this.generateResponse(r.text);return await this.client.sendText(r.from,s),{success:!0}}catch(e){throw console.error("Error en processMessage:",e),e}}generateResponse(e){let r=e.toLowerCase();return r.includes("hola")?"\xa1Hola! \xbfEn qu\xe9 puedo ayudarte?":r.includes("gracias")?"\xa1Es un placer ayudarte! \uD83D\uDE0A":"Hemos recibido tu mensaje. Te responderemos pronto."}constructor(){this.client=new c.A}}async function d(e){if(console.log("[WEBHOOK] Iniciando procesamiento"),!e||"whatsapp_business_account"!==e.object)return void console.error("[WEBHOOK] Payload inv\xe1lido");try{let r=new l,s=e.entry?.[0],t=s?.changes?.[0],o=t?.value?.messages?.[0];o?(console.log("[WEBHOOK] Mensaje detectado:",o.type),await r.processMessage(o)):console.log("[WEBHOOK] Evento sin mensaje:",t?.value)}catch(e){throw console.error("[WEBHOOK] Error procesando mensaje:",e),e}}let h=process.env.WHATSAPP_WEBHOOK_TOKEN||"MTT0K3N123";async function g(e){let r=new URL(e.url),s=r.searchParams.get("hub.verify_token"),t=r.searchParams.get("hub.challenge");return(console.log("Token recibido:",s),s===h&&t)?new Response(t,{status:200,headers:{"Content-Type":"text/plain"}}):new Response("Token inv\xe1lido",{status:403})}async function w(e){try{let r=await e.json();return console.log("Mensaje recibido:",JSON.stringify(r,null,2)),await d(r),i.NextResponse.json({success:!0})}catch(e){return console.error("Error en POST:",e),i.NextResponse.json({error:"Error interno"},{status:500})}}let m=new o.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/whatsapp/webhook/route",pathname:"/api/whatsapp/webhook",filename:"route",bundlePath:"app/api/whatsapp/webhook/route"},resolvedPagePath:"C:\\Users\\EQUIPO 2\\whatsapp-clean\\src\\app\\api\\whatsapp\\webhook\\route.ts",nextConfigOutput:"",userland:t}),{workAsyncStorage:v,workUnitAsyncStorage:x,serverHooks:y}=m;function E(){return(0,n.patchFetch)({workAsyncStorage:v,workUnitAsyncStorage:x})}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},68311:()=>{},73825:(e,r,s)=>{"use strict";s.d(r,{A:()=>t});class t{constructor(){this.baseUrl="https://graph.facebook.com/v19.0/573143728457"}async getContacts(){try{return[{id:"521234567890",name:"Cliente Ejemplo",lastMessage:"Hola, \xbfc\xf3mo est\xe1s?",unread:2,lastMessageTime:new Date}]}catch(e){throw console.error("Error fetching contacts:",e),e}}async sendText(e,r){let s=await fetch(`${this.baseUrl}/messages`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({messaging_product:"whatsapp",recipient_type:"individual",to:e,text:{body:r}})});return this.handleResponse(s)}getHeaders(){return{Authorization:"Bearer EAAdmskc6SHwBOxuBjULMfPWk2V6AmDlfeZCTUDUtgj4UmAXAICaI7QEO5H5vH5gZCPOsEC555PIFBv3ob13L1kl0f7Jlt79b99R1IEWEkCZAZBbiNZCFNZCbHjH3k6WxKTD5j5hvC3Y5awZBwDjk3JnYG5BIzr9Hr0p1PpzO0YUqSwiu5rU2fRUdZBg1Px7thVXNZCuJLaYLpVLdzVCPshkPD2iFvpxoZD","Content-Type":"application/json"}}async handleResponse(e){if(!e.ok){let r=await e.json();throw console.error("WhatsApp API Error:",r),Error(r.error?.message||"WhatsApp API error")}return e.json()}}},78335:()=>{},96487:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[719,580],()=>s(55009));module.exports=t})();