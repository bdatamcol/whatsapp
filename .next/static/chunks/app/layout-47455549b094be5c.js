(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[177],{2747:()=>{},5302:e=>{e.exports={style:{fontFamily:"'Inter', 'Inter Fallback'",fontStyle:"normal"},className:"__className_d65c78",variable:"__variable_d65c78"}},11049:(e,t,s)=>{Promise.resolve().then(s.t.bind(s,5302,23)),Promise.resolve().then(s.t.bind(s,51956,23)),Promise.resolve().then(s.t.bind(s,30347,23)),Promise.resolve().then(s.bind(s,23142))},13718:()=>{},16592:()=>{},21406:()=>{},22855:()=>{},23142:(e,t,s)=>{"use strict";s.d(t,{Providers:()=>r});var a=s(95155),o=s(55982);function r(e){let{children:t}=e;return(0,a.jsx)(o.q,{children:t})}},23488:()=>{},25320:()=>{},28426:()=>{},29069:()=>{},30347:()=>{},41541:()=>{},47698:()=>{},49065:()=>{},51956:e=>{e.exports={style:{fontFamily:"'Roboto Mono', 'Roboto Mono Fallback'",fontStyle:"normal"},className:"__className_43fb55",variable:"__variable_43fb55"}},55982:(e,t,s)=>{"use strict";let a,o;s.d(t,{q:()=>w,M:()=>v});var r=s(95155),n=s(12115),i=s(49509);class c{async getContacts(){try{return[{id:"521234567890",name:"Cliente Ejemplo",lastMessage:"Hola, \xbfc\xf3mo est\xe1s?",unread:2,lastMessageTime:new Date}]}catch(e){throw console.error("Error fetching contacts:",e),e}}async sendText(e,t){let s=await fetch("".concat(this.baseUrl,"/messages"),{method:"POST",headers:this.getHeaders(),body:JSON.stringify({messaging_product:"whatsapp",recipient_type:"individual",to:e,text:{body:t}})});return this.handleResponse(s)}getHeaders(){if(!i.env.WHATSAPP_ACCESS_TOKEN)throw Error("Missing WHATSAPP_ACCESS_TOKEN in environment");return{Authorization:"Bearer ".concat(i.env.WHATSAPP_ACCESS_TOKEN),"Content-Type":"application/json"}}async handleResponse(e){if(!e.ok){var t;let s=await e.json();throw console.error("WhatsApp API Error:",s),Error((null==(t=s.error)?void 0:t.message)||"WhatsApp API error")}return e.json()}constructor(){if(!i.env.WHATSAPP_PHONE_NUMBER_ID)throw Error("Missing WHATSAPP_PHONE_NUMBER_ID in environment");this.baseUrl="https://graph.facebook.com/".concat("v19.0","/").concat(i.env.WHATSAPP_PHONE_NUMBER_ID)}}var l=s(80544),m=s(49509);async function d(){if(!a){if(!m.env.MONGODB_URI)throw Error("MONGODB_URI no est\xe1 definido en las variables de entorno");a=new l.MongoClient(m.env.MONGODB_URI),await a.connect(),o=a.db(m.env.MONGODB_DB||"whatsapp-business")}return o}async function g(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50,s=arguments.length>2?arguments[2]:void 0;try{let a=await d(),o={$or:[{from:e},{to:e}]};return s&&(o.timestamp={$lt:s}),(await a.collection("messages").find(o).sort({timestamp:-1}).limit(t).toArray()).map(e=>({id:e.id,text:e.text||"",direction:e.direction||"inbound",timestamp:e.timestamp instanceof Date?e.timestamp.toISOString():e.timestamp||new Date().toISOString(),...e.status&&{status:e.status},...e.type&&{type:e.type},...e.media&&{media:e.media}}))}catch(e){throw console.error("[DB] Error al obtener mensajes:",e),e}}async function u(){try{let e=await d(),t=[{$sort:{timestamp:-1}},{$group:{_id:{$cond:[{$eq:["$direction","outbound"]},"$to","$from"]},lastMessage:{$first:"$$ROOT"}}},{$replaceRoot:{newRoot:"$lastMessage"}}];return(await e.collection("messages").aggregate(t).toArray()).map(e=>({id:e.id,text:e.text||"",direction:e.direction||"inbound",timestamp:e.timestamp instanceof Date?e.timestamp.toISOString():e.timestamp||new Date().toISOString(),...e.status&&{status:e.status},...e.type&&{type:e.type},...e.media&&{media:e.media}}))}catch(e){throw console.error("[DB] Error al obtener \xfaltimos mensajes:",e),e}}(async function e(){try{let e=await d();await e.collection("messages").createIndex({from:1}),await e.collection("messages").createIndex({to:1}),await e.collection("messages").createIndex({timestamp:-1}),await e.collection("messages").createIndex({from:1,to:1,timestamp:-1}),console.log("[DB] \xcdndices creados correctamente")}catch(e){console.error("[DB] Error al crear \xedndices:",e)}})().catch(console.error);var p=s(49509);let h=s(22213).io,f=(0,n.createContext)(void 0),w=e=>{let{children:t}=e,[s,a]=(0,n.useState)({contacts:[],messages:[],selectedContact:null,loading:!1,error:null,unreadCounts:{}}),[o,i]=(0,n.useState)(null),l=new c;(0,n.useEffect)(()=>{let e=h(p.env.NEXT_PUBLIC_SOCKET_URL||"http://localhost:3001",{transports:["websocket"],reconnectionAttempts:5,reconnectionDelay:1e3});return e.on("connect",()=>{console.log("Conectado al servidor Socket.io")}),e.on("disconnect",()=>{console.log("Desconectado del servidor Socket.io")}),e.on("newMessage",e=>{a(t=>{let s=t.contacts.map(t=>t.id===e.from||t.id===e.to?{...t,lastMessage:e.text,lastMessageTime:e.timestamp}:t),a={...t.unreadCounts};t.selectedContact!==e.from&&"inbound"===e.direction&&(a[e.from]=(a[e.from]||0)+1);let o=t.messages.findIndex(t=>t.id===e.id);if(-1!==o){let r=[...t.messages];return r[o]=e,{...t,contacts:s,messages:r,unreadCounts:a}}return{...t,contacts:s,messages:[e,...t.messages],unreadCounts:a}})}),i(e),()=>{e.disconnect()}},[]);let m=(0,n.useCallback)(async()=>{a(e=>({...e,loading:!0,error:null}));try{let e=await fetch("/api/whatsapp/contacts");if(!e.ok)throw Error("Error al cargar contactos");let t=await e.json(),s=[];if(t.length>0)try{s=await u()}catch(e){console.error("Error al obtener \xfaltimos mensajes:",e)}let o=t.map(e=>{let t=s.find(t=>t.from===e.id||t.to===e.id);return{...e,lastMessage:(null==t?void 0:t.text)||"",lastMessageTime:(null==t?void 0:t.timestamp)||new Date().toISOString(),isOnline:Math.random()>.5}});a(e=>({...e,contacts:o,loading:!1}))}catch(e){console.error("Error loading contacts:",e),a(e=>({...e,error:"Error al cargar contactos",loading:!1}))}},[]),d=(0,n.useCallback)(async e=>{if(s.selectedContact&&e.trim()){a(e=>({...e,loading:!0,error:null}));try{let t="temp-".concat(Date.now()),r={id:t,from:s.selectedContact,text:e,timestamp:new Date().toISOString(),direction:"outbound",status:"sending"};a(e=>({...e,messages:[...e.messages,r]}));let n=await l.sendText(s.selectedContact,e);a(e=>({...e,messages:e.messages.map(e=>e.id===t?{...e,id:n.id,status:"sent"}:e),loading:!1})),a(t=>({...t,contacts:t.contacts.map(t=>t.id===s.selectedContact?{...t,lastMessage:e,lastMessageTime:new Date().toISOString()}:t)})),o&&o.emit("newMessage",{...r,id:n.id,status:"sent"})}catch(e){console.error("Error sending message:",e),a(e=>({...e,messages:e.messages.filter(e=>!e.id.startsWith("temp-")),error:"Error al enviar mensaje",loading:!1}))}}},[s.selectedContact,o]),w=(0,n.useCallback)(async e=>{a(t=>({...t,selectedContact:e,loading:!0,error:null,unreadCounts:{...t.unreadCounts,[e]:0}}));try{let t=await g(e);a(e=>({...e,messages:t,loading:!1}))}catch(e){console.error("Error loading messages:",e),a(e=>({...e,error:"Error al cargar mensajes",loading:!1}))}},[]),v=(0,n.useCallback)(async()=>{if(s.selectedContact&&0!==s.messages.length&&!s.loading){a(e=>({...e,loading:!0,error:null}));try{let e=s.messages[s.messages.length-1];if(!(null==e?void 0:e.timestamp))return console.warn("No se encontr\xf3 timestamp en el mensaje m\xe1s antiguo"),a(e=>({...e,loading:!1}));let t="string"==typeof e.timestamp?e.timestamp:e.timestamp instanceof Date?e.timestamp.toISOString():new Date().toISOString(),o=await g(s.selectedContact,20,t);a(e=>({...e,messages:o.length>0?[...e.messages,...o]:e.messages,loading:!1}))}catch(e){console.error("Error al cargar m\xe1s mensajes:",e),a(e=>({...e,error:"Error al cargar m\xe1s mensajes",loading:!1}))}}},[s.selectedContact,s.messages,s.loading]),_=(0,n.useCallback)(e=>{a(t=>({...t,messages:t.messages.map(t=>t.id===e?{...t,status:"read"}:t)}))},[]);return(0,n.useEffect)(()=>{m();let e=setInterval(m,3e4);return()=>clearInterval(e)},[m]),(0,r.jsx)(f.Provider,{value:{...s,selectContact:w,sendMessage:d,refreshContacts:m,loadMoreMessages:v,markAsRead:_},children:t})},v=()=>{let e=(0,n.useContext)(f);if(!e)throw Error("useWhatsApp debe usarse dentro de WhatsAppProvider");return e}},61693:()=>{},66792:()=>{},71604:()=>{},87094:()=>{}},e=>{var t=t=>e(e.s=t);e.O(0,[754,501,268,946,851,441,684,358],()=>t(11049)),_N_E=e.O()}]);